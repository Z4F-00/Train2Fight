local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local Character = Player.Character
local Humanoid = Character:WaitForChild("Humanoid")

-- Handle Scrolling
local settingGui = PlayerGui:WaitForChild("SettingGui")
local contentFrame = settingGui:WaitForChild("ContentFrame")
local settingFrame = contentFrame:WaitForChild("SettingFrame")
local settingScrolling = settingFrame:WaitForChild("SettingScrolling")
settingScrolling.AutomaticCanvasSize = Enum.AutomaticSize.Y
settingScrolling.ScrollBarThickness = 0

-- Tamplate
local tamplate = settingScrolling:WaitForChild("SettingItem")

-- Clone
local playerSpeedSetting = tamplate:Clone()
playerSpeedSetting.Name = "playerSpeedSetting"
playerSpeedSetting.Parent = settingScrolling
playerSpeedSetting.Visible = true

local SetItemName = playerSpeedSetting:WaitForChild("SetItemName")
SetItemName.Text = "Player Speed"
SetItemName.Position = UDim2.new(0.3, 0, 0.474, 0)

local progressFrame = playerSpeedSetting:WaitForChild("ProgressFrame")
local sliderAndLine = progressFrame:WaitForChild("SliderAndLine")
local sliderFrame = sliderAndLine:WaitForChild("SliderFrame")
local slider = sliderFrame:WaitForChild("Slider")
local setItemCurNum = playerSpeedSetting:WaitForChild("SetItemCurNum")
local line = sliderAndLine:WaitForChild("Line")
local progressClickBut = progressFrame:WaitForChild("ProgressClickBut")

-- MinimumText
local setItemMinNum = playerSpeedSetting:WaitForChild("SetItemMinNum")
setItemMinNum.Text = "16"
local setItemMinNumText2Num = tonumber(setItemMinNum.Text)

-- Config
local configuration = Player:WaitForChild("Configuration")
local trainSystem = configuration:WaitForChild("TrainSystem")

-- Train System Attribute
trainSystem:SetAttribute("PlayerSpeed", (100 - setItemMinNumText2Num) / 2 + setItemMinNumText2Num)

local isDragging = false

-- Destroy
for _, child in pairs(playerSpeedSetting:GetChildren()) do
    if child.Name ~= "SetItemName" and child.Name ~= "UICorner" and child.Name ~= "ProgressFrame" and child.Name ~= "SetItemCurNum" and child.Name ~= "SetItemMinNum" then
        child:Destroy()
    end
end

-- Fungsi untuk memperbarui posisi slider, lebar line, dan teks angka
local function updateSlider(inputPosition: Vector2)
    -- Mengkonversi koordinat layar ke koordinat relatif terhadap SliderAndLine Frame
    local relativeMouseX = inputPosition.X - sliderAndLine.AbsolutePosition.X
    local sliderLineWidth = sliderAndLine.AbsoluteSize.X
    
    -- SliderAndLine
    local clampedX = math.clamp(relativeMouseX, 0, sliderLineWidth)
    
    -- Persentage
    local percentage = clampedX / sliderLineWidth
    
    -- Slider pos
    sliderFrame.Position = UDim2.new(percentage, 0, sliderFrame.Position.Y.Scale, 0)
    
    -- Line size
    line.Size = UDim2.new(percentage, 0, line.Size.Y.Scale, 0)
    
    -- Minimum speed
    local minimum = percentage * (100 - setItemMinNumText2Num) + setItemMinNumText2Num
    
    -- Floor
    local flooredMinimum = math.floor(minimum + 0.5)
    
    -- Use floor
    setItemCurNum.Text = tostring(flooredMinimum)
    
    -- Player Speed
    trainSystem:SetAttribute("PlayerSpeed", flooredMinimum)
end

-- Start drag
progressClickBut.InputBegan:Connect(function(input: InputObject, gameProcessedEvent: boolean)
    if gameProcessedEvent then return end
    
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        isDragging = true
        updateSlider(input.Position)
    end
end)

-- On drag
UserInputService.InputChanged:Connect(function(input: InputObject, gameProcessedEvent: boolean)
    if not isDragging then return end
    
    -- Pastikan input yang kita tanggapi adalah pergerakan mouse atau sentuhan yang sedang kita gunakan untuk drag
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        updateSlider(input.Position)
        trainSystem:SetAttribute("PlayerSpeed", tonumber(setItemCurNum.Text))
    end
end)

-- Drag end
UserInputService.InputEnded:Connect(function(input: InputObject)
    -- Hentikan dragging hanya jika tombol mouse dilepas atau sentuhan dihentikan
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        isDragging = false
    end
end)

-- Start UI
local initialPercentage = (trainSystem:GetAttribute("PlayerSpeed") - tonumber(setItemMinNumText2Num)) / (100 - tonumber(setItemMinNumText2Num))
local initialMinimum = initialPercentage * (100 - setItemMinNumText2Num) + setItemMinNumText2Num
initialFlooredMinimum = math.floor(initialMinimum + 0.5)
sliderFrame.Position = UDim2.new(initialPercentage, 0, sliderFrame.Position.Y.Scale, 0)
line.Size = UDim2.new(initialPercentage, 0, line.Size.Y.Scale, 0)
setItemCurNum.Text = tostring(initialFlooredMinimum)

-- WalkSpeed
RunService.Heartbeat:Connect(function()
    Humanoid.WalkSpeed = trainSystem:GetAttribute("PlayerSpeed")
end)