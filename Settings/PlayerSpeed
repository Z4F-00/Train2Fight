local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local Character = Player.Character or Player.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")

local settingGui = PlayerGui:WaitForChild("SettingGui")
local contentFrame = settingGui:WaitForChild("ContentFrame")
local settingFrame = contentFrame:WaitForChild("SettingFrame")
local settingScrolling = settingFrame:WaitForChild("SettingScrolling")
settingScrolling.AutomaticCanvasSize = Enum.AutomaticSize.Y
settingScrolling.ScrollBarThickness = 0

local tamplate = settingScrolling:WaitForChild("SettingItem")

local playerSpeedSetting = tamplate:Clone()
playerSpeedSetting.Name = "playerSpeedSetting"
playerSpeedSetting.Parent = settingScrolling
playerSpeedSetting.Visible = true

local SetItemName = playerSpeedSetting:WaitForChild("SetItemName")
SetItemName.Text = "Player Speed"
SetItemName.Position = UDim2.new(0.3, 0, 0.474, 0)

local progressFrame = playerSpeedSetting:WaitForChild("ProgressFrame")
local sliderAndLine = progressFrame:WaitForChild("SliderAndLine")
local sliderFrame = sliderAndLine:WaitForChild("SliderFrame")
local slider = sliderFrame:WaitForChild("Slider")
local setItemCurNum = playerSpeedSetting:WaitForChild("SetItemCurNum")
local line = sliderAndLine:WaitForChild("Line")
local progressClickBut = progressFrame:WaitForChild("ProgressClickBut")

local setItemMinNum = playerSpeedSetting:WaitForChild("SetItemMinNum")
setItemMinNum.Text = "16"
local setItemMinNumText2Num = tonumber(setItemMinNum.Text)

local configuration = Player:WaitForChild("Configuration")
local trainSystem = configuration:WaitForChild("TrainSystem")

local path = "Z4F Script/Train to Fight/Settings"
local savedSpeed = _G.loadFile(path, "PlayerSpeed", setItemMinNumText2Num)
trainSystem:SetAttribute("PlayerSpeed", savedSpeed)

local isDragging = false

for _, child in pairs(playerSpeedSetting:GetChildren()) do
    if child.Name ~= "SetItemName" and child.Name ~= "UICorner" and child.Name ~= "ProgressFrame" and child.Name ~= "SetItemCurNum" and child.Name ~= "SetItemMinNum" then
        child:Destroy()
    end
end

local function updateSlider(inputPosition: Vector2)
    local relativeMouseX = inputPosition.X - sliderAndLine.AbsolutePosition.X
    local sliderLineWidth = sliderAndLine.AbsoluteSize.X
    local clampedX = math.clamp(relativeMouseX, 0, sliderLineWidth)
    local percentage = clampedX / sliderLineWidth
    
    sliderFrame.Position = UDim2.new(percentage, 0, sliderFrame.Position.Y.Scale, 0)
    line.Size = UDim2.new(percentage, 0, line.Size.Y.Scale, 0)
    
    local speedValue = percentage * (100 - setItemMinNumText2Num) + setItemMinNumText2Num
    local flooredSpeed = math.floor(speedValue + 0.5)
    
    if trainSystem:GetAttribute("PlayerSpeed") ~= flooredSpeed then
        setItemCurNum.Text = tostring(flooredSpeed)
        trainSystem:SetAttribute("PlayerSpeed", flooredSpeed)
    end
end

progressClickBut.InputBegan:Connect(function(input: InputObject, gameProcessedEvent: boolean)
    if gameProcessedEvent then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        isDragging = true
        updateSlider(input.Position)
    end
end)

UserInputService.InputChanged:Connect(function(input: InputObject, gameProcessedEvent: boolean)
    if not isDragging then return end
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        updateSlider(input.Position)
    end
end)

UserInputService.InputEnded:Connect(function(input: InputObject)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        if isDragging then
            isDragging = false
            _G.saveFile(path, "PlayerSpeed", trainSystem:GetAttribute("PlayerSpeed"))
        end
    end
end)

local currentSpeedAttr = trainSystem:GetAttribute("PlayerSpeed")
local initialPercentage = (currentSpeedAttr - setItemMinNumText2Num) / (100 - setItemMinNumText2Num)
sliderFrame.Position = UDim2.new(initialPercentage, 0, sliderFrame.Position.Y.Scale, 0)
line.Size = UDim2.new(initialPercentage, 0, line.Size.Y.Scale, 0)
setItemCurNum.Text = tostring(currentSpeedAttr)

RunService.Heartbeat:Connect(function()
    if Character and Character:FindFirstChild("Humanoid") then
        local targetSpeed = trainSystem:GetAttribute("PlayerSpeed")
        if Character.Humanoid.WalkSpeed ~= targetSpeed then
            Character.Humanoid.WalkSpeed = targetSpeed
        end
    end
end)

Player.CharacterAdded:Connect(function(newChar)
    Character = newChar
    Humanoid = newChar:WaitForChild("Humanoid")
end)
