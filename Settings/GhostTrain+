local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local AttrController = require(ReplicatedStorage:WaitForChild("Attr"):WaitForChild("Script"):WaitForChild("AttrController"))
local TrainSystem = LocalPlayer.Configuration:WaitForChild("TrainSystem")
local oldGetAttr = AttrController.GetAttrValueByInstance

if setreadonly then setreadonly(AttrController, false) end
AttrController.GetAttrValueByInstance = function(self, instance, attrIndex)
    local isGhostPlusActive = TrainSystem:GetAttribute("IsGhostTrainPlus")
    
    if isGhostPlusActive and instance == LocalPlayer then
        local id = tonumber(attrIndex)
        if id == 74 then return 0, 1000000 end
    end
    return oldGetAttr(self, instance, attrIndex)
end
if setreadonly then setreadonly(AttrController, true) end

local settingFrame = PlayerGui:WaitForChild("SettingGui"):WaitForChild("ContentFrame"):WaitForChild("SettingFrame"):WaitForChild("SettingScrolling")
settingFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
settingFrame.ScrollBarThickness = 0

local trainRemotes = ReplicatedStorage:WaitForChild("TrainEquipment"):WaitForChild("Remote")
local applyStationary = trainRemotes:WaitForChild("ApplyStationaryTrain")
local applyMobile = trainRemotes:WaitForChild("ApplyMobileTrain")

local heartbeatConnection
local ghostTrainSetting, toggleBox, stroke
local offProps, onProps, offStroke, onStroke, tweenInfo

local function createInSettingGui()
    ghostTrainSetting = settingFrame.SettingItem:Clone()
    ghostTrainSetting.Name = "GhostTrainPlusSetting" 
    ghostTrainSetting.Parent = settingFrame
    ghostTrainSetting.Visible = true

    for _, child in pairs(ghostTrainSetting:GetChildren()) do
        if child.Name ~= "SetItemName" and child.Name ~= "UICorner" then child:Destroy() end
    end

    ghostTrainSetting.SetItemName.Text = "Ghost Train+(Potential Lag)"
    ghostTrainSetting.SetItemName.Position = UDim2.new(0.3, 0, 0.474, 0)

    local toggleFrame = Instance.new("Frame", ghostTrainSetting)
    toggleFrame.Size = UDim2.new(0.15, 0, 0.553, 0)
    toggleFrame.Position = UDim2.new(0.85, 0, 0.5, 0)
    toggleFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    toggleFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    toggleFrame.BorderSizePixel = 0
    Instance.new("UICorner", toggleFrame).CornerRadius = UDim.new(0.15, 0)

    stroke = Instance.new("UIStroke", toggleFrame)
    stroke.Transparency = 0.5
    stroke.Thickness = 1.2

    toggleBox = Instance.new("Frame", toggleFrame)
    toggleBox.Size = UDim2.new(0.49, 0, 0.8, 0)
    toggleBox.BorderSizePixel = 0
    Instance.new("UICorner", toggleBox).CornerRadius = UDim.new(0.1)

    local clickButton = Instance.new("TextButton", toggleFrame)
    clickButton.Size = UDim2.new(1, 0, 1, 0)
    clickButton.BackgroundTransparency = 1
    clickButton.Text = ""

    offProps = {Position = UDim2.new(0.05, 0, 0.1, 0), BackgroundColor3 = Color3.new(1, 1, 1)}
    onProps = {Position = UDim2.new(0.465, 0, 0.1, 0), BackgroundColor3 = Color3.fromRGB(255, 248, 45)}
    offStroke = {Color = Color3.new(1, 1, 1)}
    onStroke = {Color = Color3.fromRGB(255, 248, 45)}
    tweenInfo = TweenInfo.new(0.167, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

    clickButton.MouseButton1Click:Connect(function()
        local current = TrainSystem:GetAttribute("IsGhostTrainPlus")
        TrainSystem:SetAttribute("IsGhostTrainPlus", not current)
    end)
end

if not settingFrame:FindFirstChild("GhostTrainPlusSetting") then createInSettingGui() end

local function handleGhostTrainChange(val)
    if not toggleBox or not stroke then return end
    TweenService:Create(toggleBox, tweenInfo, val and onProps or offProps):Play()
    TweenService:Create(stroke, tweenInfo, val and onStroke or offStroke):Play()
    
    if val then
        if not heartbeatConnection then
            heartbeatConnection = RunService.Heartbeat:Connect(function()
                for i = 1, 75 do
                    pcall(function()
                        applyStationary:InvokeServer(1)
                        applyMobile:InvokeServer(1)
                    end)
                end
            end)
        end
    else
        if heartbeatConnection then
            heartbeatConnection:Disconnect()
            heartbeatConnection = nil
        end
    end
end

TrainSystem:GetAttributeChangedSignal("IsGhostTrainPlus"):Connect(function()
    handleGhostTrainChange(TrainSystem:GetAttribute("IsGhostTrainPlus"))
end)

local initial = TrainSystem:GetAttribute("IsGhostTrainPlus") or false
TrainSystem:SetAttribute("IsGhostTrainPlus", initial)
handleGhostTrainChange(initial)
