local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local settingFrame = PlayerGui:WaitForChild("SettingGui"):WaitForChild("ContentFrame"):WaitForChild("SettingFrame"):WaitForChild("SettingScrolling")
settingFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
settingFrame.ScrollBarThickness = 0

local SettingItem = settingFrame:WaitForChild("SettingItem")

local Area = {
	workspace:WaitForChild("Area"):WaitForChild("PlayerArea"):WaitForChild("S2")
}

local Remote = game:GetService("ReplicatedStorage"):WaitForChild("Area"):WaitForChild("Remote")
local PlayerAreaOut = Remote:WaitForChild("PlayerAreaOut")
local PlayerAreaIn = Remote:WaitForChild("PlayerAreaIn")

function invokePVP(PVPType)
	if PVPType then
		PlayerAreaOut:InvokeServer(unpack(Area))
	else
		PlayerAreaIn:InvokeServer(unpack(Area))
	end
end

local pvpAreaGuiOn = PlayerGui:WaitForChild("SafeAreaGui"):WaitForChild("ContentFrame"):WaitForChild("On")

local path = "Z4F Script/Train to Fight/Settings"
local savedStatus = _G.loadFile(path, "PVP", false)

if pvpAreaGuiOn.Visible ~= savedStatus then
    invokePVP(savedStatus)
    pvpAreaGuiOn.Visible = savedStatus
end

local pvpSetting
local toggleBox
local stroke
local offProperties
local onProperties
local offPropertiesStroke
local onPropertiesStroke
local tweenInfo

local function createInSettingGui()
	pvpSetting = SettingItem:Clone()
	pvpSetting.Name = "PVPSetting"
	pvpSetting.Parent = settingFrame
	pvpSetting.Visible = true

	for _, child in pairs(pvpSetting:GetChildren()) do
        if child.Name ~= "SetItemName" and child.Name ~= "UICorner" then
            child:Destroy()
        end
    end

	local SetItemName = pvpSetting:WaitForChild("SetItemName")
	SetItemName.Text = "PVP"
	SetItemName.Position = UDim2.new(0.3, 0, 0.474, 0)

	local toggleFrame = Instance.new("Frame")
	toggleFrame.Name = "ToggleFrame"
	toggleFrame.Size = UDim2.new(0.15, 0, 0.553, 0)
	toggleFrame.Position = UDim2.new(0.85, 0, 0.5, 0)
	toggleFrame.AnchorPoint = Vector2.new(0.5, 0.5)
	toggleFrame.BackgroundColor3 = Color3.new(0, 0, 0)
	toggleFrame.BorderSizePixel = 0
	toggleFrame.Parent = pvpSetting

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0.15, 0)
	corner.Parent = toggleFrame

	stroke = Instance.new("UIStroke")
	stroke.Color = Color3.new(1, 1, 1)
	stroke.Transparency = 0.5
	stroke.Thickness = 1.2
	stroke.Parent = toggleFrame

	toggleBox = Instance.new("Frame")
	toggleBox.Name = "ToggleBox"
	toggleBox.Size = UDim2.new(0.49, 0, 0.8, 0)
	toggleBox.Position = UDim2.new(0.05, 0, 0.1, 0)
	toggleBox.BackgroundColor3 = Color3.new(1, 1, 1)
	toggleBox.BorderSizePixel = 0
	toggleBox.Parent = toggleFrame

	local cornerToggleBox = corner:Clone()
	cornerToggleBox.CornerRadius = UDim.new(0.1)
	cornerToggleBox.Parent = toggleBox

	local clickButton = Instance.new("TextButton")
	clickButton.Name = "ClickButton"
	clickButton.Size = UDim2.new(1, 0, 1, 0)
	clickButton.BackgroundTransparency = 1
	clickButton.Text = ""
	clickButton.Parent = toggleFrame

    offProperties = {
        Position = UDim2.new(0.05, 0, 0.1, 0),
        BackgroundColor3 = Color3.new(1, 1, 1)
    }
    onProperties = {
        Position = UDim2.new(0.465, 0, 0.1, 0),
        BackgroundColor3 = Color3.fromRGB(255, 248, 45)
    }

    offPropertiesStroke = {
        Color = Color3.new(1, 1, 1)
    }
    onPropertiesStroke = {
        Color = Color3.fromRGB(255, 248, 45)
    }

	tweenInfo = TweenInfo.new(0.167, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

	clickButton.MouseButton1Click:Connect(function()
		local currentStatus = pvpAreaGuiOn.Visible
        local nextStatus = not currentStatus
		invokePVP(nextStatus)
        _G.saveFile(path, "PVP", nextStatus)
		pvpAreaGuiOn.Visible = nextStatus
	end)
end

local getPVPSettingGui = settingFrame:FindFirstChild("PVPSetting")
if not getPVPSettingGui then
	createInSettingGui()
end

local function handlePVPChange(newValue)
	if not toggleBox or not stroke then return end

	if newValue == true then
		TweenService:Create(toggleBox, tweenInfo, onProperties):Play()
		TweenService:Create(stroke, tweenInfo, onPropertiesStroke):Play()
	else
		TweenService:Create(toggleBox, tweenInfo, offProperties):Play()
		TweenService:Create(stroke, tweenInfo, offPropertiesStroke):Play()
	end
end

pvpAreaGuiOn:GetPropertyChangedSignal("Visible"):Connect(function()
	handlePVPChange(pvpAreaGuiOn.Visible)
end)

handlePVPChange(pvpAreaGuiOn.Visible)
