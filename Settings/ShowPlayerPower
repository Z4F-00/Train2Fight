local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local settingFrame = PlayerGui:WaitForChild("SettingGui"):WaitForChild("ContentFrame"):WaitForChild("SettingFrame"):WaitForChild("SettingScrolling")
local SettingItem = settingFrame:WaitForChild("SettingItem")

settingFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
settingFrame.ScrollBarThickness = 0

local path = "Z4F Script/Train to Fight/Settings"
local isPowerTagsActive = _G.loadFile(path, "ShowPower", true)

local powerTagsSetting
local toggleBox
local stroke
local offProperties
local onProperties
local offPropertiesStroke
local onPropertiesStroke
local tweenInfo

function suffixValue(number)
    local absNumber = math.abs(number)
    local suffixes = {"", "K", "M", "B", "T", "Qa.", "Qi.", "aa.", "ab.", "ac.", "ad.", "ae.", "af.", "ag.", "ah.", "ai.", "aj.", "ak.", "al.", "am.", "an.", "ap.", "aq.", "ar.", "as.", "at.", "au.", "av.", "aw.", "ax.", "ay.", "az."}
    local i = 1
    if absNumber >= 1000^#suffixes then
        return string.format("%.2e", number)
    end
    while absNumber >= 1000 and i < #suffixes do
        absNumber = absNumber / 1000
        i = i + 1
    end
    local formattedString = string.format("%.2f", absNumber)
    if string.find(formattedString, "%.00$") then
        formattedString = string.gsub(formattedString, "%.00$", "")
    elseif string.find(formattedString, "%.0$") then
        formattedString = string.gsub(formattedString, "%.0$", "")
    end
    local finalString = formattedString .. " " .. suffixes[i]
    if number < 0 then
        return "-" .. finalString
    else
        return finalString
    end
end

function TrainSystemGetAttribute(player, AttributeName)
    local config = player:FindFirstChild("Configuration")
    if config then
        local trainSystem = config:FindFirstChild("TrainSystem")
        if trainSystem then
            return trainSystem:GetAttribute(AttributeName) or 0
        end
    end
    return 0
end

local function updatePowerText(player, powerNum)
    local function calculateTotalPower(p)
        return TrainSystemGetAttribute(p, "1") + 
               TrainSystemGetAttribute(p, "2") + 
               TrainSystemGetAttribute(p, "3") + 
               TrainSystemGetAttribute(p, "4")
    end
    local otherPower = calculateTotalPower(player)
    local playerPower = calculateTotalPower(LocalPlayer)
    powerNum.Text = suffixValue(otherPower)
    local white = Color3.new(1, 1, 1)
    local electric_lime = Color3.fromRGB(204, 255, 0)
    local cyan = Color3.fromRGB(0, 255, 255)
    local ratio = 1
    local powerColor
    if playerPower > otherPower then
        ratio = playerPower ~= 0 and otherPower / playerPower or 1
        powerColor = electric_lime:Lerp(white, ratio)
    elseif otherPower > playerPower then
        ratio = otherPower ~= 0 and playerPower / otherPower or 1
        powerColor = cyan:Lerp(white, ratio)
    else
        powerColor = white
    end
    powerNum.TextColor3 = powerColor
end

local pvpAreaGuiOn = PlayerGui:WaitForChild("SafeAreaGui"):WaitForChild("ContentFrame"):WaitForChild("On")

local function setPowerTagVisibility(visible)
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local character = player.Character
            if character then
                local head = character:FindFirstChild("Head")
                if head then
                    local billboard = head:FindFirstChild("playerTagGui")
                    if billboard and billboard:FindFirstChild("powerGui") then
                        billboard.powerGui.Visible = visible
                    end
                end
            end
        end
    end
end

local function handlePowerTagsChange(newValue)
    if not toggleBox or not stroke then return end
    isPowerTagsActive = newValue
    _G.saveFile(path, "ShowPower", newValue)
    if isPowerTagsActive then
        TweenService:Create(toggleBox, tweenInfo, onProperties):Play()
        TweenService:Create(stroke, tweenInfo, onPropertiesStroke):Play()
        setPowerTagVisibility(true)
    else
        TweenService:Create(toggleBox, tweenInfo, offProperties):Play()
        TweenService:Create(stroke, tweenInfo, offPropertiesStroke):Play()
        setPowerTagVisibility(pvpAreaGuiOn.Visible)
    end
end

local function createPowerTagsSettingGui()
    powerTagsSetting = SettingItem:Clone()
    powerTagsSetting.Name = "PowerTagsSetting"
    powerTagsSetting.Parent = settingFrame
    powerTagsSetting.Visible = true
    for _, child in pairs(powerTagsSetting:GetChildren()) do
        if child.Name ~= "SetItemName" and child.Name ~= "UICorner" then
            child:Destroy()
        end
    end
    local SetItemName = powerTagsSetting:WaitForChild("SetItemName")
    SetItemName.Text = "Show Player Power"
    SetItemName.Position = UDim2.new(0.3, 0, 0.474, 0)
    local toggleFrame = Instance.new("Frame")
    toggleFrame.Name = "ToggleFrame"
    toggleFrame.Size = UDim2.new(0.15, 0, 0.553, 0)
    toggleFrame.Position = UDim2.new(0.85, 0, 0.5, 0)
    toggleFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    toggleFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    toggleFrame.BorderSizePixel = 0
    toggleFrame.Parent = powerTagsSetting
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0.15, 0)
    corner.Parent = toggleFrame
    stroke = Instance.new("UIStroke")
    stroke.Color = Color3.new(1, 1, 1)
    stroke.Transparency = 0.5
    stroke.Thickness = 1.2
    stroke.Parent = toggleFrame
    toggleBox = Instance.new("Frame")
    toggleBox.Name = "ToggleBox"
    toggleBox.Size = UDim2.new(0.49, 0, 0.8, 0)
    toggleBox.Position = UDim2.new(0.05, 0, 0.1, 0)
    toggleBox.BackgroundColor3 = Color3.new(1, 1, 1)
    toggleBox.BorderSizePixel = 0
    toggleBox.Parent = toggleFrame
    local cornerToggleBox = corner:Clone()
    cornerToggleBox.CornerRadius = UDim.new(0.1)
    cornerToggleBox.Parent = toggleBox
    local clickButton = Instance.new("TextButton")
    clickButton.Name = "ClickButton"
    clickButton.Size = UDim2.new(1, 0, 1, 0)
    clickButton.BackgroundTransparency = 1
    clickButton.Text = ""
    clickButton.Parent = toggleFrame
    offProperties = {Position = UDim2.new(0.05, 0, 0.1, 0), BackgroundColor3 = Color3.new(1, 1, 1)}
    onProperties = {Position = UDim2.new(0.465, 0, 0.1, 0), BackgroundColor3 = Color3.fromRGB(255, 248, 45)}
    offPropertiesStroke = {Color = Color3.new(1, 1, 1)}
    onPropertiesStroke = {Color = Color3.fromRGB(255, 248, 45)}
    tweenInfo = TweenInfo.new(0.167, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    clickButton.MouseButton1Click:Connect(function()
        handlePowerTagsChange(not isPowerTagsActive)
    end)
end

local function createTag(player)
    if player == LocalPlayer then return end
    local character = player.Character or player.CharacterAdded:Wait()
    local head = character:WaitForChild("Head")
    if not head:FindFirstChild("playerTagGui") then
        local localPowerArea = PlayerGui:WaitForChild("MainGui"):WaitForChild("LeftFrame"):WaitForChild("LeftButtonArea"):WaitForChild("PowerArea")
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "playerTagGui"
        billboard.Adornee = head
        billboard.Size = UDim2.new(8, 0, 4, 0)
        billboard.StudsOffset = Vector3.new(0, 0, 0)
        billboard.AlwaysOnTop = true
        billboard.MaxDistance = 200
        billboard.Parent = head
        local clonedPowerGui = localPowerArea:Clone()
        clonedPowerGui.Name = "powerGui"
        clonedPowerGui.Position = UDim2.new(0, 0, 0, 0)
        clonedPowerGui.AnchorPoint = Vector2.new(0, 0)
        clonedPowerGui.Size = UDim2.new(1, 0, 1, 0)
        clonedPowerGui.Visible = isPowerTagsActive
        local powerNum = clonedPowerGui:WaitForChild("PowerButton"):WaitForChild("PowerNum")
        updatePowerText(player, powerNum)
        clonedPowerGui.Parent = billboard
        local trainSystem = player:WaitForChild("Configuration"):WaitForChild("TrainSystem")
        for i = 1, 4 do
            trainSystem:GetAttributeChangedSignal(tostring(i)):Connect(function()
                if isPowerTagsActive or pvpAreaGuiOn.Visible then 
                    updatePowerText(player, powerNum)
                end
            end)
        end
    end
end

Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function() createTag(player) end)
end)

for _, player in ipairs(Players:GetPlayers()) do
    createTag(player)
end

if not settingFrame:FindFirstChild("PowerTagsSetting") then
    createPowerTagsSettingGui()
end

handlePowerTagsChange(isPowerTagsActive)
