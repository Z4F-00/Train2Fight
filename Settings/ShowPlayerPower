local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local RunService = game:GetService("RunService")

local allSuffixes = (function()
    local s = {"", "K", "M", "B", "T", "Qa.", "Qi."}
    local alphabet = "abcdefghijklmnopqrstuvwxyz"
    for i = 1, #alphabet do
        local char1 = string.sub(alphabet, i, i)
        for j = 1, #alphabet do
            table.insert(s, char1 .. string.sub(alphabet, j, j) .. ".")
        end
    end
    return s
end)()

function suffixValue(number)
    local absNumber = math.abs(number)
    if absNumber == 0 then return "0" end
    
    local i = math.floor(math.log(absNumber, 1000)) + 1
    
    if i > #allSuffixes then return string.format("%.2e", number) end
    
    local shortened = absNumber / (1000 ^ (i - 1))
    local formatted = string.format("%.2f", shortened):gsub("%.?0+$", "")
    
    local res = formatted .. " " .. allSuffixes[i]
    return number < 0 and "-" .. res or res
end

local settingFrame = PlayerGui:WaitForChild("SettingGui"):WaitForChild("ContentFrame"):WaitForChild("SettingFrame"):WaitForChild("SettingScrolling")
local SettingItem = settingFrame:WaitForChild("SettingItem")

settingFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
settingFrame.ScrollBarThickness = 0

repeat task.wait() until _G.loadFile and _G.saveFile

local path = "Z4F Script/Train to Fight/Settings"
local isPowerTagsActive = _G.loadFile(path, "ShowPower", true)

local powerTagsSetting
local toggleBox
local stroke
local offProperties
local onProperties
local offPropertiesStroke
local onPropertiesStroke
local tweenInfo

function TrainSystemGetAttribute(player, AttributeName)
    local config = player:FindFirstChild("Configuration")
    if config then
        local trainSystem = config:FindFirstChild("TrainSystem")
        if trainSystem then
            return trainSystem:GetAttribute(AttributeName) or 0
        end
    end
    return 0
end

function updatePowerText(player, powerNum)
    local function calculateTotalPower(p)
        return TrainSystemGetAttribute(p, "1") + 
               TrainSystemGetAttribute(p, "2") + 
               TrainSystemGetAttribute(p, "3") + 
               TrainSystemGetAttribute(p, "4")
    end
    
    local otherPower = calculateTotalPower(player)
    local playerPower = calculateTotalPower(LocalPlayer)
    local originalText = suffixValue(otherPower)
    powerNum.Text = originalText

    if not powerNum:GetAttribute("OriginalPos") then
        powerNum:SetAttribute("OriginalPos", powerNum.Position)
    end
    local originalPos = powerNum:GetAttribute("OriginalPos")

    local white = Color3.fromRGB(255, 255, 255)
    local soft_lime = Color3.fromRGB(190, 255, 130)
    local majestic_blue = Color3.fromRGB(0, 220, 255)
    local crystal_white = Color3.fromRGB(220, 245, 255)
    local diffRatio = playerPower ~= 0 and (otherPower / playerPower) or 1
    
    if powerNum:FindFirstChild("EffectLoop") then powerNum.EffectLoop:Destroy() end
    local effectLoop = Instance.new("BoolValue")
    effectLoop.Name = "EffectLoop"
    effectLoop.Parent = powerNum

    if otherPower > playerPower then
        if diffRatio >= 1000000 then
            local glitchTime = 0
            local conn = RunService.RenderStepped:Connect(function(dt)
                if not effectLoop or not effectLoop.Parent then return end
                if glitchTime <= 0 and math.random() > 0.985 then
                    glitchTime = 0.2 + (math.random() * 0.3)
                end

                if glitchTime > 0 then
                    glitchTime = glitchTime - dt
                    powerNum.TextColor3 = Color3.fromHSV(math.random(), 0.5, 1)
                    powerNum.Position = originalPos + UDim2.new(0, math.random(-8, 8), 0, math.random(-8, 8))
                    powerNum.Text = string.char(math.random(33, 126)) .. string.char(math.random(33, 126)) .. "!!"
                    powerNum.TextTransparency = 0.4
                else
                    local shimmer = math.abs(math.sin(tick() * 3))
                    powerNum.TextColor3 = crystal_white:Lerp(white, shimmer)
                    powerNum.Position = originalPos
                    powerNum.Text = originalText
                    powerNum.TextTransparency = 0
                end
            end)
            effectLoop.Destroying:Connect(function() conn:Disconnect() end)
            
        elseif diffRatio >= 10000 then
            local progressToFinal = math.clamp((diffRatio - 10000) / 990000, 0, 1)
            local currentColor = majestic_blue:Lerp(crystal_white, progressToFinal)
            
            local glitchTime = 0
            local conn = RunService.RenderStepped:Connect(function(dt)
                if not effectLoop or not effectLoop.Parent then return end
                if glitchTime <= 0 and math.random() > 0.99 then glitchTime = 0.15 end

                if glitchTime > 0 then
                    glitchTime = glitchTime - dt
                    local intensity = 4 + (4 * progressToFinal)
                    powerNum.Position = originalPos + UDim2.new(0, math.random(-intensity, intensity), 0, math.random(-intensity, intensity))
                    powerNum.TextTransparency = 0.5
                else
                    powerNum.TextColor3 = currentColor
                    powerNum.Position = originalPos
                    powerNum.TextTransparency = 0
                end
            end)
            effectLoop.Destroying:Connect(function() conn:Disconnect() end)
            
        else
            local ratio = math.clamp(diffRatio / 10000, 0, 1)
            powerNum.TextColor3 = white:Lerp(majestic_blue, ratio)
            powerNum.Position = originalPos
            
            local conn = RunService.RenderStepped:Connect(function()
                if not effectLoop or not effectLoop.Parent then return end
                local speed = 1 + (7 * ratio)
                local pulse = math.sin(tick() * speed)
                local intensity = 0.75 * ratio
                powerNum.TextTransparency = math.clamp((pulse * 0.5 + 0.5) * intensity, 0, 0.8)
            end)
            effectLoop.Destroying:Connect(function() conn:Disconnect() end)
        end
    elseif playerPower > otherPower then
        local ratio = math.clamp(otherPower / playerPower, 0, 1)
        powerNum.TextColor3 = white:Lerp(soft_lime, 1 - ratio)
        powerNum.TextTransparency = 0
        powerNum.Position = originalPos
    else
        powerNum.TextColor3 = white
        powerNum.TextTransparency = 0
        powerNum.Position = originalPos
    end
end

local pvpAreaGuiOn = PlayerGui:WaitForChild("SafeAreaGui"):WaitForChild("ContentFrame"):WaitForChild("On")

local function setPowerTagVisibility(visible)
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local character = player.Character
            if character then
                local head = character:FindFirstChild("Head")
                if head then
                    local billboard = head:FindFirstChild("playerTagGui")
                    if billboard and billboard:FindFirstChild("powerGui") then
                        billboard.powerGui.Visible = visible
                    end
                end
            end
        end
    end
end

local function handlePowerTagsChange(newValue)
    if not toggleBox or not stroke then return end
    isPowerTagsActive = newValue
    _G.saveFile(path, "ShowPower", newValue)
    if isPowerTagsActive then
        TweenService:Create(toggleBox, tweenInfo, onProperties):Play()
        TweenService:Create(stroke, tweenInfo, onPropertiesStroke):Play()
        setPowerTagVisibility(true)
    else
        TweenService:Create(toggleBox, tweenInfo, offProperties):Play()
        TweenService:Create(stroke, tweenInfo, offPropertiesStroke):Play()
        setPowerTagVisibility(pvpAreaGuiOn.Visible)
    end
end

local function createPowerTagsSettingGui()
    powerTagsSetting = SettingItem:Clone()
    powerTagsSetting.Name = "PowerTagsSetting"
    powerTagsSetting.Parent = settingFrame
    powerTagsSetting.Visible = true
    for _, child in pairs(powerTagsSetting:GetChildren()) do
        if child.Name ~= "SetItemName" and child.Name ~= "UICorner" then
            child:Destroy()
        end
    end
    local SetItemName = powerTagsSetting:WaitForChild("SetItemName")
    SetItemName.Text = "Show Player Power"
    SetItemName.Position = UDim2.new(0.3, 0, 0.474, 0)
    local toggleFrame = Instance.new("Frame")
    toggleFrame.Name = "ToggleFrame"
    toggleFrame.Size = UDim2.new(0.15, 0, 0.553, 0)
    toggleFrame.Position = UDim2.new(0.85, 0, 0.5, 0)
    toggleFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    toggleFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    toggleFrame.BorderSizePixel = 0
    toggleFrame.Parent = powerTagsSetting
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0.15, 0)
    corner.Parent = toggleFrame
    stroke = Instance.new("UIStroke")
    stroke.Color = Color3.new(1, 1, 1)
    stroke.Transparency = 0.5
    stroke.Thickness = 1.2
    stroke.Parent = toggleFrame
    toggleBox = Instance.new("Frame")
    toggleBox.Name = "ToggleBox"
    toggleBox.Size = UDim2.new(0.49, 0, 0.8, 0)
    toggleBox.Position = UDim2.new(0.05, 0, 0.1, 0)
    toggleBox.BackgroundColor3 = Color3.new(1, 1, 1)
    toggleBox.BorderSizePixel = 0
    toggleBox.Parent = toggleFrame
    local cornerToggleBox = corner:Clone()
    cornerToggleBox.CornerRadius = UDim.new(0.1)
    cornerToggleBox.Parent = toggleBox
    local clickButton = Instance.new("TextButton")
    clickButton.Name = "ClickButton"
    clickButton.Size = UDim2.new(1, 0, 1, 0)
    clickButton.BackgroundTransparency = 1
    clickButton.Text = ""
    clickButton.Parent = toggleFrame
    offProperties = {Position = UDim2.new(0.05, 0, 0.1, 0), BackgroundColor3 = Color3.new(1, 1, 1)}
    onProperties = {Position = UDim2.new(0.465, 0, 0.1, 0), BackgroundColor3 = Color3.fromRGB(255, 248, 45)}
    offPropertiesStroke = {Color = Color3.new(1, 1, 1)}
    onPropertiesStroke = {Color = Color3.fromRGB(255, 248, 45)}
    tweenInfo = TweenInfo.new(0.167, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    clickButton.MouseButton1Click:Connect(function()
        handlePowerTagsChange(not isPowerTagsActive)
    end)
end

local function createTag(player)
    if player == LocalPlayer then return end
    local character = player.Character or player.CharacterAdded:Wait()
    local head = character:WaitForChild("Head")
    if not head:FindFirstChild("playerTagGui") then
        local localPowerArea = PlayerGui:WaitForChild("MainGui"):WaitForChild("LeftFrame"):WaitForChild("LeftButtonArea"):WaitForChild("PowerArea")
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "playerTagGui"
        billboard.Adornee = head
        billboard.Size = UDim2.new(8, 0, 4, 0)
        billboard.StudsOffset = Vector3.new(0, 0, 0)
        billboard.AlwaysOnTop = true
        billboard.MaxDistance = 200
        billboard.Parent = head
        local clonedPowerGui = localPowerArea:Clone()
        clonedPowerGui.Name = "powerGui"
        clonedPowerGui.Position = UDim2.new(0, 0, 0, 0)
        clonedPowerGui.AnchorPoint = Vector2.new(0, 0)
        clonedPowerGui.Size = UDim2.new(1, 0, 1, 0)
        clonedPowerGui.Visible = isPowerTagsActive
        local powerNum = clonedPowerGui:WaitForChild("PowerButton"):WaitForChild("PowerNum")
        updatePowerText(player, powerNum)
        clonedPowerGui.Parent = billboard
        local trainSystem = player:WaitForChild("Configuration"):WaitForChild("TrainSystem")
        for i = 1, 4 do
            trainSystem:GetAttributeChangedSignal(tostring(i)):Connect(function()
                if isPowerTagsActive or pvpAreaGuiOn.Visible then 
                    updatePowerText(player, powerNum)
                end
            end)
        end
    end
end

Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function() createTag(player) end)
end)

for _, player in ipairs(Players:GetPlayers()) do
    createTag(player)
end

if not settingFrame:FindFirstChild("PowerTagsSetting") then
    createPowerTagsSettingGui()
end

handlePowerTagsChange(isPowerTagsActive)
